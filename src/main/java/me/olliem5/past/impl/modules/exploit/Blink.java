package me.olliem5.past.impl.modules.exploit;

import com.mojang.realmsclient.gui.ChatFormatting;
import me.olliem5.past.api.module.ModuleInfo;
import me.olliem5.past.impl.events.PacketEvent;
import me.olliem5.past.api.module.Category;
import me.olliem5.past.api.module.Module;
import me.zero.alpine.listener.EventHandler;
import me.zero.alpine.listener.Listener;
import net.minecraft.client.entity.EntityOtherPlayerMP;
import net.minecraft.entity.player.EntityPlayer;
import net.minecraft.network.play.client.CPacketPlayer;

import java.util.LinkedList;
import java.util.Queue;

@ModuleInfo(name = "Blink", description = "Hides movement for a short time", category = Category.EXPLOIT)
public class Blink extends Module {

    Queue<CPacketPlayer> packets = new LinkedList<>();

    @EventHandler
    public Listener<PacketEvent.Send> listener = new Listener<>(event -> {
        if (event.getPacket() instanceof CPacketPlayer) {
            event.cancel();
            packets.add((CPacketPlayer) event.getPacket());
        }
    });

    @Override
    public void onEnable() {
        if (mc.world == null) return;

        EntityOtherPlayerMP fakePlayer = new EntityOtherPlayerMP(mc.world, mc.getSession().getProfile());
        fakePlayer.copyLocationAndAnglesFrom(mc.player);
        fakePlayer.rotationYawHead = mc.player.rotationYawHead;
        mc.world.addEntityToWorld(-100, fakePlayer);
    }

    @Override
    public void onDisable() {
        while (!packets.isEmpty()) {
            mc.player.connection.sendPacket(packets.poll());
        }

        EntityPlayer localPlayer = mc.player;

        if (localPlayer != null) {
            mc.world.removeEntityFromWorld(-100);
        }
    }

    public String getArraylistInfo() {
        return ChatFormatting.GRAY + " " + packets.size();
    }
}
